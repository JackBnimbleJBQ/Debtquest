<!<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DebtQuest ‚Äî Cyberpunk Neon</title>
<style>
  :root{
    --bg:#04040a; --card:#081024; --muted:#9fb3c8;
    --neon1:#00f6ff; --neon2:#7b61ff; --neon3:#ff2fa6; --accent:#00f6ff;
    --glass: rgba(255,255,255,0.03); --soft:#e6f9fb;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
    background: radial-gradient(1200px 600px at 10% 10%, rgba(123,97,255,0.06), transparent),
                radial-gradient(800px 400px at 90% 90%, rgba(255,47,166,0.03), transparent),
                linear-gradient(180deg,#020214 0%, #04040a 100%);
    color:var(--soft); -webkit-font-smoothing:antialiased;
  }
  .wrap{max-width:960px;margin:18px auto;padding:18px}
  h1{font-family:"Segoe UI Black",ui-sans-serif,system-ui;font-weight:800;margin:6px 0 14px;font-size:20px;text-align:center;letter-spacing:0.6px;color:var(--neon1); text-shadow:0 2px 18px rgba(0,246,255,0.08)}
  .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:44px;height:44px;background:linear-gradient(135deg,var(--neon2),var(--neon3));border-radius:8px;display:flex;align-items:center;justify-content:center;color:#02030a;font-weight:900;font-size:18px;box-shadow:0 6px 30px rgba(123,97,255,0.12)}
  .pill{background:linear-gradient(90deg,rgba(0,246,255,0.06),rgba(123,97,255,0.04));padding:6px 10px;border-radius:999px;font-weight:700;color:var(--neon1);border:1px solid rgba(123,97,255,0.08);}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);border-radius:12px;padding:14px;margin:14px 0;box-shadow:0 10px 40px rgba(2,6,23,0.55)}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:8px}
  input[type="text"],input[type="number"],select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:rgba(0,0,0,0.18);color:var(--soft);outline:none}
  input[type="text"]:focus,input[type="number"]:focus,select:focus{box-shadow:0 0 12px rgba(0,246,255,0.06);border-color:rgba(0,246,255,0.18)}
  .row{display:flex;gap:10px}
  .col{flex:1}
  button{background:linear-gradient(90deg,var(--neon1),var(--neon2));color:#02121a;padding:10px 12px;border-radius:10px;border:none;font-weight:800;cursor:pointer;letter-spacing:0.6px}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--soft)}
  .small{font-size:13px;color:var(--muted)}
  .enemy-list .enemy{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;background:linear-gradient(90deg, rgba(123,97,255,0.02), rgba(0,246,255,0.01));margin-bottom:8px;border:1px solid rgba(255,255,255,0.02)}
  .hp-wrap{height:12px;background:rgba(255,255,255,0.02);border-radius:10px;margin-top:8px;overflow:hidden}
  .hp-bar{height:100%;background:linear-gradient(90deg,var(--neon1),var(--neon3));width:100%;transition:width 600ms ease-in-out;box-shadow:0 6px 24px rgba(123,97,255,0.06)}
  .grid{display:grid;grid-template-columns:1fr 380px;gap:16px}
  @media (max-width:860px){.grid{grid-template-columns:1fr}}
  .intensity-grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:620px){.intensity-grid{grid-template-columns:1fr 1fr}}
  .card-intensity{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border:1px solid rgba(255,255,255,0.03);padding:12px;border-radius:12px;cursor:pointer;transition:transform .14s, box-shadow .14s, border-color .14s}
  .card-intensity:hover{transform:translateY(-6px);box-shadow:0 18px 50px rgba(0,246,255,0.04)}
  .card-intensity.sel{border-color:rgba(0,246,255,0.22);box-shadow:0 20px 60px rgba(123,97,255,0.08);transform:translateY(-8px)}
  .tiny{font-size:12px;color:var(--muted);margin-top:6px}
  .priority-bar{height:10px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden;margin-top:6px}
  .priority-fill{height:100%;background:linear-gradient(90deg,#ffd166,#ff6b6b);width:20%}
  .log{height:140px;overflow:auto;background:linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.25));border-radius:10px;padding:10px;margin-top:10px;font-size:13px;color:#cfeff6;border:1px solid rgba(255,255,255,0.02)}
  .muted{color:var(--muted)}
  footer{margin-top:16px;color:var(--muted);text-align:center;font-size:12px}
  .neon-tag{display:inline-block;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,rgba(0,246,255,0.04),rgba(123,97,255,0.03));color:var(--neon1);font-weight:800;border:1px solid rgba(0,246,255,0.06)}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <div class="logo">DQ</div>
      <div>
        <div style="font-weight:800;color:var(--neon2)">DebtQuest</div>
        <div class="small muted">Cyberpunk Neon ‚Ä¢ Strategy-aware</div>
      </div>
    </div>
    <div class="neon-tag" id="saveIndicator">Saved</div>
  </div>

  <h1>DebtQuest ‚Äî Cyber Neon ‚Ä¢ Choose Payment Intensity</h1>

  <div class="grid">
    <!-- LEFT column -->
    <div>
      <div class="card">
        <h3 style="color:var(--neon1)">Add Debt (Enemy)</h3>
        <div class="row" style="margin-top:8px">
          <div class="col">
            <label>Name</label>
            <input id="inpName" placeholder="e.g., VISA (last 4)">
          </div>
          <div style="width:130px">
            <label>Balance</label>
            <input id="inpBal" type="number" placeholder="2500">
          </div>
          <div style="width:110px">
            <label>APR</label>
            <input id="inpApr" placeholder="26.99 or 0.2699">
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button id="btnAdd">Add Debt</button>
          <button id="btnClear" class="ghost">Clear All</button>
          <button id="btnExport" class="ghost">Export CSV</button>
        </div>

        <div style="margin-top:12px">
          <label>Enemies</label>
          <div id="enemyList" class="enemy-list"></div>
        </div>

        <div style="margin-top:12px" class="small">APR accepts percent (26.99) or decimal (0.2699). Click a Payment Intensity to proceed.</div>
      </div>

      <div class="card" id="card-intensity-panel" style="margin-top:10px">
        <h3 style="color:var(--neon2)">üí• Payment Intensity</h3>
        <div class="small muted">Select how aggressively you want to allocate payments this run.</div>

        <div class="intensity-grid" id="intensityGrid" style="margin-top:12px">
          <div class="card-intensity" data-id="1" id="int-1">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong style="color:var(--neon1)">üê¢ Minimum Survival</strong><div class="tiny">Realistic bank-style minimum only</div></div>
              <div class="small muted">Min</div>
            </div>
          </div>

          <div class="card-intensity" data-id="2" id="int-2">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong style="color:var(--neon2)">‚öîÔ∏è Standard Warrior</strong><div class="tiny">Minimum √ó 1.2 ‚Äî steady progress</div></div>
              <div class="small muted">Std</div>
            </div>
          </div>

          <div class="card-intensity" data-id="3" id="int-3">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong style="color:var(--neon3)">üß™ Heroic Challenge</strong><div class="tiny">Minimum √ó 1.6 ‚Äî aggressive payoff</div></div>
              <div class="small muted">Agg</div>
            </div>
          </div>

          <div class="card-intensity" data-id="4" id="int-4">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong style="color:#ffd166">üèÜ Legendary Overdrive</strong><div class="tiny">Enter a monthly budget ‚Äî system allocates across debts</div></div>
              <div class="small muted">Over</div>
            </div>
          </div>

          <div class="card-intensity" data-id="5" id="int-5">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong style="color:#ff6b6b">üî• Doom Slayer</strong><div class="tiny">Locked until you defeat 3 debts</div></div>
              <div class="small muted">Locked</div>
            </div>
          </div>
        </div>

        <div id="legendaryBox" style="display:none;margin-top:10px">
          <label>Monthly Budget for Overdrive ($)</label>
          <input id="legendBudget" type="number" placeholder="e.g., 1000">
          <div class="tiny" style="margin-top:6px;color:var(--muted)">Budget must be ‚â• realistic monthly minimums to be valid.</div>
        </div>

        <div style="margin-top:12px" class="row">
          <button id="btnAnalyze">Analyze Strategies</button>
          <button id="btnRun" class="ghost">Run Selected</button>
        </div>
      </div>

      <div id="runCard" class="card hidden" style="margin-top:12px">
        <h3 style="color:var(--neon1)">Run Results</h3>
        <div id="runSummary" class="small muted"></div>
        <div id="runDetails" style="margin-top:8px"></div>
        <div style="margin-top:10px" class="log" id="runLog"></div>
      </div>
    </div>

    <!-- RIGHT column -->
    <div>
      <div class="card">
        <h3 style="color:var(--neon2)">Strategy Comparison</h3>
        <div id="strategyResults" class="small muted">Add debts and click <strong>Analyze Strategies</strong>.</div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3 style="color:var(--neon3)">Selected Strategy</h3>
        <div id="chosenCard" class="small muted">No strategy chosen yet</div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3 style="color:var(--neon1)">Export & Save</h3>
        <div class="small muted">Data saves locally. Export CSV to back up or share results.</div>
        <div style="margin-top:8px" class="row">
          <button id="btnSave">Save</button>
          <button id="btnReset" class="ghost">Reset</button>
        </div>
      </div>
    </div>
  </div>

  <footer>Prototype ‚Äî simulation approximates monthly credit-card amortization. Verify with statements.</footer>
</div>

<script>
/* Cyberpunk DebtQuest ‚Äî logic preserved, visual updated.
   Features: APR parse, T3 solver (monthly amortization),
   M3 user min control (cards intensity), strategies (avalanche/snowball/hybrid),
   analyze & simulate, export, localStorage.
*/

// Utilities
const $ = id => document.getElementById(id);
const fmt = n => Number(n).toLocaleString(undefined,{maximumFractionDigits:2});
const clamp = (v,m,M) => Math.max(m,Math.min(M,v));

// state
let state = { enemies:[], chosenStrategy:'avalanche', intensity:1, lastAnalysis:null, defeatedCount:0 };

// storage
function saveState(){ localStorage.setItem('dq_state_cyber', JSON.stringify(state)); $('saveIndicator').innerText = 'Saved'; setTimeout(()=>$('saveIndicator').innerText='Saved',600);}
function loadState(){ const d=localStorage.getItem('dq_state_cyber'); if(d) state=JSON.parse(d); }
function resetState(){ localStorage.removeItem('dq_state_cyber'); state={ enemies:[], chosenStrategy:'avalanche', intensity:1, lastAnalysis:null, defeatedCount:0}; saveState(); renderAll(); }

// APR parse helper: percent or decimal
function parseApr(v){
  if(v===undefined || v===null || v==='') return 0;
  const n=Number(v);
  if(isNaN(n)) return 0;
  if(n>1) return n/100.0;
  return n;
}

// Render enemies list
function renderEnemyList(){
  const el = $('enemyList'); el.innerHTML = '';
  if(!state.enemies.length){ el.innerHTML = '<div class="small muted">No debts yet.</div>'; return; }
  state.enemies.forEach((d,i)=>{
    const div = document.createElement('div'); div.className='enemy';
    div.innerHTML = `<div>
        <strong style="color:var(--neon1)">${d.name}</strong>
        <div class="tiny muted">Balance: $${fmt(d.balance)} ‚Ä¢ APR: ${(d.apr*100).toFixed(2)}%</div>
      </div>
      <div style="text-align:right">
        <div class="hp-wrap"><div class="hp-bar" style="width:${(d.balance/d.max)*100}%"></div></div>
        <div style="height:8px"></div>
        <button class="ghost" onclick="removeEnemy(${i})">Remove</button>
      </div>`;
    el.appendChild(div);
  });
}

// add / remove
function addEnemy(){
  const name = $('inpName').value.trim();
  const bal = parseFloat($('inpBal').value);
  const aprraw = $('inpApr').value.trim();
  const apr = parseApr(aprraw);
  if(!name || isNaN(bal) || bal <= 0) return alert('Enter valid name & balance');
  state.enemies.push({ name, balance: Math.round(bal*100)/100, apr: apr, max: Math.round(bal*100)/100 });
  $('inpName').value=''; $('inpBal').value=''; $('inpApr').value='';
  saveState(); renderAll();
}
function removeEnemy(i){ if(!confirm('Remove this debt?')) return; state.enemies.splice(i,1); saveState(); renderAll(); }

// realistic min payment calculation (interest + 1% of principal, floored at $25)
function realisticMin(debt){
  const monthlyRate = debt.apr/12;
  const interest = Math.round(debt.balance * monthlyRate *100)/100;
  const principalPortion = Math.round(debt.balance * 0.01 *100)/100;
  return Math.max(interest + principalPortion, 25);
}

// ordering functions
function orderForStrategy(arr, strategy){
  const copy = arr.slice();
  if(strategy === 'avalanche') copy.sort((a,b)=> (b.apr - a.apr) || (a.balance - b.balance));
  else if(strategy === 'snowball') copy.sort((a,b)=> (a.balance - b.balance) || (b.apr - a.apr));
  else {
    function score(x){ return (x.apr*100)*0.6 - (x.balance)*0.0004; }
    copy.sort((a,b)=> score(b) - score(a));
  }
  return copy;
}

// clone debts helper
function cloneDebts(debts){ return debts.map(d=>({ name:d.name, balance:Math.max(0,Number(d.balance)), apr:Number(d.apr), max:Number(d.max) })); }

// simulator (monthly amortization)
function simulatePayoff(originalDebts, opts){
  // opts: { intensity:1..4 (or 5), legendaryBudget, strategy }
  const debts = cloneDebts(originalDebts);
  const strategy = opts.strategy || 'avalanche';
  const intensity = opts.intensity || 1;
  const legendaryBudget = Number(opts.legendaryBudget) || 0;
  const rows = [];
  let month=0;
  const maxMonths=600;
  if(!debts.some(d=>d.balance>0.005)) return { months:0, totalPaid:0, totalInterest:0, rows:[] };

  while(debts.some(d=>d.balance>0.005) && month < maxMonths){
    month++;
    // compute min payments
    let payments = debts.map(d=>{
      if(d.balance <= 0.005) return 0;
      const minP = realisticMin(d);
      // intensity rules:
      if(intensity === 1) return Math.min(minP, d.balance);
      if(intensity === 2) return Math.min(Math.round(minP*1.2*100)/100, d.balance);
      if(intensity === 3) return Math.min(Math.round(minP*1.6*100)/100, d.balance);
      if(intensity === 4) {
        // legendary: allocate from legendBudget proportionally later, but for now return min
        return Math.min(minP, d.balance);
      }
      if(intensity === 5) return Math.min(Math.round(minP*3*100)/100, d.balance);
      return Math.min(minP, d.balance);
    });

    // extra allocation
    if(intensity === 4 && legendaryBudget > 0){
      // distribute legendaryBudget across active debts according to strategy weights
      const active = debts.filter(d=>d.balance>0.005);
      const ordered = orderForStrategy(active, strategy);
      // first, pay mins
      let extraLeft = legendaryBudget - payments.reduce((s,p)=>s+p,0);
      if(extraLeft < 0) extraLeft = 0;
      for(const target of ordered){
        if(extraLeft <= 0) break;
        const idx = debts.indexOf(target);
        const remaining = Math.max(0, debts[idx].balance - payments[idx]);
        const add = Math.min(remaining, extraLeft);
        payments[idx] = Math.round((payments[idx] + add)*100)/100;
        extraLeft = Math.round((extraLeft - add)*100)/100;
      }
      // if still extra, distribute proportionally
      if(extraLeft > 0){
        const active2 = debts.filter(d=>d.balance>0.005);
        const totalBal = active2.reduce((s,d)=>s+d.balance,0);
        if(totalBal > 0){
          active2.forEach(d=>{
            const idx = debts.indexOf(d);
            const share = d.balance / totalBal;
            const add = Math.min(extraLeft * share, d.balance - payments[idx]);
            payments[idx] = Math.round((payments[idx] + add)*100)/100;
          });
        }
      }
    } else {
      // for intensities 1-3 and 5: allocate extra according to strategy; extra is (minP*(multiplier-1)) already baked in
      // no further distribution needed
    }

    // apply interest/principal
    let totalInterestThisMonth=0, totalPaymentThisMonth=0;
    const monthRow=[];
    for(let i=0;i<debts.length;i++){
      const d = debts[i];
      if(d.balance <= 0.005){ monthRow.push({name:d.name,balance:0,payment:0,interest:0,principal:0,apr:d.apr}); continue; }
      const monthlyRate = d.apr / 12.0;
      const interest = Math.round((d.balance * monthlyRate)*100)/100;
      let payment = Math.round((payments[i]||0)*100)/100;
      let principal = Math.round((payment - interest)*100)/100;
      if(principal < 0){
        // negative amortization
        d.balance = Math.round((d.balance + (interest - payment))*100)/100;
        totalInterestThisMonth += interest;
        totalPaymentThisMonth += payment;
        monthRow.push({name:d.name,balance:d.balance,payment,interest,principal:0,apr:d.apr});
      } else {
        d.balance = Math.round(Math.max(0, d.balance - principal)*100)/100;
        totalInterestThisMonth += interest;
        totalPaymentThisMonth += payment;
        monthRow.push({name:d.name,balance:d.balance,payment,interest,principal,apr:d.apr});
      }
    }

    rows.push({ month, totalPayment:Math.round(totalPaymentThisMonth*100)/100, totalInterest:Math.round(totalInterestThisMonth*100)/100, debts:monthRow });
    if(Math.round(totalPaymentThisMonth*100)/100 <= 0.001) break;
  }

  const months = rows.length;
  const totalPaid = rows.reduce((s,r)=>s + r.totalPayment,0);
  const totalInterest = rows.reduce((s,r)=>s + r.totalInterest,0);
  return { months, totalPaid: Math.round(totalPaid*100)/100, totalInterest: Math.round(totalInterest*100)/100, rows };
}

// Strategy analysis: compute baseline (min-only) and each strategy
function analyzeStrategies(){
  if(!state.enemies.length) return alert('Add debts first');
  const intensity = state.intensity || 1;
  const legendaryBudget = Number($('legendBudget') ? $('legendBudget').value : 0) || 0;
  // baseline: min-only (intensity=1)
  const baseline = simulatePayoff(state.enemies, { intensity:1, strategy:'avalanche' });
  const strategies = ['avalanche','snowball','hybrid'];
  const results = strategies.map(s=>{
    const res = simulatePayoff(state.enemies, { intensity, legendaryBudget, strategy: s });
    return { strategy:s, months:res.months, totalInterest:res.totalInterest, totalPaid:res.totalPaid, details:res };
  });
  results.sort((a,b)=> a.totalInterest - b.totalInterest || a.months - b.months);
  const recommended = results[0];
  state.lastAnalysis = { timestamp:Date.now(), baseline, results, recommended, intensity, legendaryBudget };
  saveState(); renderAnalysis();
}

// render analysis results
function renderAnalysis(){
  const out = $('strategyResults');
  out.innerHTML = '';
  if(!state.lastAnalysis) { out.innerHTML = '<div class="small muted">No analysis yet.</div>'; return; }
  const a = state.lastAnalysis;
  const base = a.baseline;
  out.innerHTML += `<div class="small muted">Baseline (min-only): Months <strong>${base.months}</strong> ‚Ä¢ Interest <strong>$${fmt(base.totalInterest)}</strong></div><hr/>`;
  a.results.forEach(r=>{
    const label = r.strategy==='avalanche' ? 'Avalanche (highest APR first)' : r.strategy==='snowball' ? 'Snowball (smallest balance first)' : 'Hybrid (weighted APR+balance)';
    out.innerHTML += `<div style="margin-bottom:10px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong style="color:var(--neon1)">${label}</strong><div class="tiny muted">Months: ${r.months} ‚Ä¢ Interest: $${fmt(r.totalInterest)} ‚Ä¢ Paid: $${fmt(r.totalPaid)}</div></div>
        <div><button class="ghost" onclick="chooseStrategy('${r.strategy}')">Choose</button></div>
      </div>
      <div class="priority-bar"><div class="priority-fill" style="width:${Math.min(100,10 + r.totalInterest/10)}%"></div></div>
    </div>`;
  });
  out.innerHTML += `<hr/><div class="small">Recommended: <strong style="color:var(--neon2)">${a.recommended.strategy.toUpperCase()}</strong> ‚Äî lowest interest ($${fmt(a.recommended.totalInterest)})</div>`;
  $('chosenCard').innerText = `Recommended: ${a.recommended.strategy.toUpperCase()} ‚Ä¢ Click Run Selected to simulate with intensity.`;
}

// choose strategy
function chooseStrategy(s){
  state.chosenStrategy = s; saveState(); renderAnalysis();
}

// run simulation for selected strategy with current intensity
function runSelected(){
  if(!state.lastAnalysis) analyzeStrategies(); // if not analyzed, do it
  if(!state.lastAnalysis) return;
  const intensity = state.intensity || 1;
  const legendaryBudget = Number($('legendBudget') ? $('legendBudget').value : 0) || 0;
  const res = simulatePayoff(state.enemies, { intensity, legendaryBudget, strategy: state.chosenStrategy || state.lastAnalysis.recommended.strategy });
  $('runCard').classList.remove('hidden');
  $('runSummary').innerHTML = `Strategy: <strong>${state.chosenStrategy || state.lastAnalysis.recommended.strategy}</strong> ‚Ä¢ Months: <strong>${res.months}</strong> ‚Ä¢ Interest: <strong>$${fmt(res.totalInterest)}</strong> ‚Ä¢ Total paid: <strong>$${fmt(res.totalPaid)}</strong>`;
  let details = '<div class="small muted">Preview (first 6 months & last 3 months)</div>';
  const rows = res.rows;
  const preview = rows.slice(0,6).concat(rows.length>9? rows.slice(-3): rows.slice(6));
  preview.forEach(r=>{
    const rem = r.debts.reduce((s,d)=>s + d.balance,0);
    details += `<div style="margin-top:6px">Month ${r.month} ‚Äî Paid: $${fmt(r.totalPayment)} ‚Ä¢ Interest: $${fmt(r.totalInterest)} ‚Ä¢ Remaining: $${fmt(rem)}</div>`;
  });
  $('runDetails').innerHTML = details;
  state.lastRun = { res, intensity, legendaryBudget, strategy: state.chosenStrategy || state.lastAnalysis.recommended.strategy };
  saveState();
}

// CSV export for last run
function exportRunCSV(){
  if(!state.lastRun) return alert('Run simulation first');
  const sim = state.lastRun.res;
  let csv = 'month,total_paid,total_interest,remaining_total\n';
  sim.rows.forEach(r=>{
    const rem = r.debts.reduce((s,d)=>s + d.balance,0);
    csv += `${r.month},${r.totalPayment.toFixed(2)},${r.totalInterest.toFixed(2)},${rem.toFixed(2)}\n`;
  });
  const blob = new Blob([csv], {type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='debtquest_run.csv'; a.click();
}

// intensity card wiring & UI
function setIntensity(i){
  state.intensity = i;
  // visual
  [1,2,3,4,5].forEach(n=>{ const el = $('int-'+n); if(el) el.classList.toggle('sel', n===i); });
  // show legendary box only for 4
  $('legendaryBox').style.display = (i===4) ? 'block' : 'none';
  saveState();
}

function initUI(){
  // intensity card clicks
  [1,2,3,4,5].forEach(n=>{
    const el = $('int-'+n);
    if(!el) return;
    el.onclick = ()=>{
      // doom slayer locked unless defeatedCount >=3
      if(n===5 && state.defeatedCount < 3){ alert('Doom Slayer unlocks after you defeat 3 debts'); return; }
      setIntensity(n);
    };
  });
  // buttons
  $('btnAdd').addEventListener('click', addEnemy);
  $('btnClear').addEventListener('click', ()=>{ if(confirm('Clear all debts?')){ state.enemies=[]; saveState(); renderAll(); }});
  $('btnExport').addEventListener('click', ()=>{
    if(!state.enemies.length) return alert('No debts'); let csv='name,balance,apr\n'; state.enemies.forEach(e=> csv += `${e.name},${e.balance},${(e.apr*100).toFixed(4)}\n`); const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='debts_export.csv'; a.click();
  });
  $('btnAnalyze').addEventListener('click', analyzeStrategies);
  $('btnRun').addEventListener('click', runSelected);
  $('btnSave').addEventListener('click', ()=>{ saveState(); alert('Saved locally'); });
  $('btnReset').addEventListener('click', ()=>{ if(confirm('Reset all saved data?')) resetState(); });
  // legendary budget input effect
  const legend = $('legendBudget');
  if(legend) legend.addEventListener('input', ()=>{ /* validate later on run */});
  // export run CSV via click on runDetails area (add button)
  // hook intensity default
  if(!state.intensity) state.intensity = 1;
  setIntensity(state.intensity);
}

// render everything
function renderAll(){
  renderEnemyList();
  renderAnalysis();
  if(state.lastRun) { $('runCard').classList.remove('hidden'); }
  else $('runCard').classList.add('hidden');
}

// init
loadState();
initUI();
renderAll();
saveState();

</script>
</body>
</html>
